<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="report">

	<resultMap type="com.kh.john.report.model.vo.Report" 
		id="reportMap">
	</resultMap>
	<resultMap type="com.kh.john.member.model.vo.Member" 
		id="memberMap">
	</resultMap>

	<!-- customer -->
	<insert id="insertReport" parameterType="report">
		INSERT INTO REPORT VALUES(SEQ_REPORT_NO.NEXTVAL,#{report_board_id},#{report_writer_usid},#{report_target_usid},
		#{report_type},#{report_title},#{report_content},default,0,#{report_user_nickname},#{report_target_nickname},
		null,0)
	</insert>
	
	<insert id="insertReportFile" parameterType="reportFile">
		INSERT INTO REPORT_FILE VALUES(#{report_id},#{report_file_name})
		<selectKey keyProperty="report_id" resultType="_int" order="BEFORE">SELECT SEQ_REPORT_NO.CURRVAL FROM DUAL</selectKey>
		
	</insert>
	
	<!-- admin -->
	<select id="selectReportList" resultMap="reportMap">
		SELECT * FROM REPORT
	</select>
	
	<select id="selectReportCount" resultType="_int">
		SELECT COUNT(*) FROM REPORT
	</select>
	
	<select id="selectOneReport" parameterType="_int" resultType="report">
		SELECT * FROM REPORT WHERE REPORT_ID=#{report_id}
	</select>
	
	<select id="selectReportFile" parameterType="_int" resultType="reportFile">
		SELECT * FROM REPORT_FILE WHERE REPORT_ID=#{report_id}
	</select>
	
	<delete id="deleteReport" parameterType="report">
		DELETE FROM REPORT WHERE REPORT_ID=#{report_id}
	</delete>
	
	<insert id="reportWarn" parameterType="report">
		UPDATE REPORT R
		SET REPORT_ISWARNING=(REPORT_ISWARNING+1) WHERE EXISTS (
		SELECT USID
		FROM MEMBER M
		WHERE R.REPORT_TARGET_USID = M.USID AND R.REPORT_TARGET_USID=#{report_target_usid})
		
	</insert>
	
	<delete id="reportWarnOut" parameterType="member">
		DELETE FROM MEMBER M WHERE
		M.USID = (SELECT R.REPORT_TARGET_USID FROM REPORT R WHERE REPORT_ISWARNING = '3')
	</delete>
	
</mapper>
